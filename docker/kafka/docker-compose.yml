services:
  # 节点1：同时为Controller（node.id=1）和Broker
  kafka-1:
    image: apache/kafka:4.1.1
    container_name: kafka-1
    networks:
      - kafka-mixed-network
    ports:
      - "29092:9092"  # 客户端访问端口（主机29092 → 容器9092）
    environment:
      # 核心配置：混合部署关键参数
      KAFKA_NODE_ID: 1  # 全局唯一节点ID（3个节点分别为1、2、3）
      KAFKA_PROCESS_ROLES: "broker,controller"  # 指定双角色：同时作为broker和controller
      
      # 监听器配置：包含3类（Controller内部/ Broker内部/ 客户端访问）
      KAFKA_LISTENERS: "CONTROLLER://:9093,PLAINTEXT://:19092,PLAINTEXT_HOST://:9092"
      # 对外暴露的监听器地址（对应上面的3个监听器，仅暴露Broker相关，Controller内部不对外）
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-1:19092,PLAINTEXT_HOST://localhost:29092"
      
      # 监听器关联配置
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT  # Broker节点间通信使用PLAINTEXT监听器
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER  # Controller内部通信使用CONTROLLER监听器
      
      # Controller集群投票列表（包含3个混合节点，格式：节点ID@容器名:Controller端口）
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093"
      
      # 辅助配置
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0  # 关闭消费者初始重平衡延迟
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3  # 偏移量主题副本数（等于节点数，高可用）
      KAFKA_NUM_PARTITIONS: 10                   # 默认分区数（可根据业务调整）
      KAFKA_LOG_DIRS: "/tmp/kafka-logs"  # 容器内消息存储目录
    volumes:
      # 数据持久化：挂载主机目录到容器，避免容器删除数据丢失
      - ./kafka-1/data:/tmp/kafka-logs



  # 节点2：同时为Controller（node.id=2）和Broker
  kafka-2:
    image: apache/kafka:4.1.1
    container_name: kafka-2
    networks:
      - kafka-mixed-network
    ports:
      - "39092:9092"  # 客户端访问端口（主机39092 → 容器9092，避免与kafka-1冲突）
    environment:
      KAFKA_NODE_ID: 2  # 全局唯一节点ID
      KAFKA_PROCESS_ROLES: "broker,controller"  # 双角色配置
      KAFKA_LISTENERS: "CONTROLLER://:9093,PLAINTEXT://:19092,PLAINTEXT_HOST://:9092"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-2:19092,PLAINTEXT_HOST://localhost:39092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 10                  
      KAFKA_LOG_DIRS: "/tmp/kafka-logs"
    volumes:
      - ./kafka-2/data:/tmp/kafka-logs


  # 节点3：同时为Controller（node.id=3）和Broker
  kafka-3:
    image: apache/kafka:4.1.1
    container_name: kafka-3
    networks:
      - kafka-mixed-network
    ports:
      - "49092:9092"  # 客户端访问端口（主机49092 → 容器9092，避免冲突）
    environment:
      KAFKA_NODE_ID: 3  # 全局唯一节点ID
      KAFKA_PROCESS_ROLES: "broker,controller"  # 双角色配置
      KAFKA_LISTENERS: "CONTROLLER://:9093,PLAINTEXT://:19092,PLAINTEXT_HOST://:9092"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-3:19092,PLAINTEXT_HOST://localhost:49092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
      KAFKA_NUM_PARTITIONS: 10                  
      KAFKA_LOG_DIRS: "/tmp/kafka-logs"
    volumes:
      - ./kafka-3/data:/tmp/kafka-logs

  # 可视化工具
  kafka-ui:
    image: provectuslabs/kafka-ui:master
    user: root
    container_name: kafka-ui
    # 移除host网络模式，加入Kafka集群的自定义网络，实现容器间互通
    networks:
      - kafka-mixed-network
    # 正常配置端口映射，主机9091端口 → 容器9091端口
    ports:
      - "9091:9091"
    restart: always
    volumes:
      # 修复时区挂载：主机时区文件 → 容器时区文件，保证时间一致（无需自定义本地目录，直接挂载系统时区）
      - /etc/localtime:/etc/localtime:ro
      # 可选：挂载Kafka-UI配置持久化目录（如需保存自定义配置）
      - ./kafka-ui/config:/app/config
    environment:
      - SERVER_PORT=9091
      - SERVER_SERVLET_CONTEXT_PATH=/
      # 保留登录认证配置（按需调整用户名密码）
      - AUTH_TYPE=LOGIN_FORM
      - SPRING_SECURITY_USER_NAME=root
      - SPRING_SECURITY_USER_PASSWORD=root
      # 集群名称修改为本地集群（更易识别）
      - KAFKA_CLUSTERS_0_NAME=local-kafka-mixed-cluster
      # 核心修改：连接本地Kafka集群（同一自定义网络内，使用容器名+Broker内部端口，稳定可靠）
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka-1:19092,kafka-2:19092,kafka-3:19092
      # 移除冗余的SASL认证配置（本地集群为PLAINTEXT明文模式，无需认证）
      - DYNAMIC_CONFIG_ENABLED=true

# 自定义网络，确保3个节点容器互通
networks:
  kafka-mixed-network:
    driver: bridge


# 测试命令
# docker exec --workdir /opt/kafka/bin/ -it kafka-1 sh

# docker exec --workdir /opt/kafka/bin/ -it kafka-2 sh

# ./kafka-topics.sh --bootstrap-server kafka-1:19092,kafka-2:19092,kafka-3:19092 --create --topic test-topic  	
# ./kafka-console-producer.sh --bootstrap-server kafka-1:19092,kafka-2:19092,kafka-3:19092 --topic test-topic
# ./kafka-console-consumer.sh --bootstrap-server kafka-1:19092,kafka-2:19092,kafka-3:19092 --topic test-topic --from-beginning 
